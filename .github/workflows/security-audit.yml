name: Weekly Security Audit

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run npm audit
        id: npm-audit
        run: |
          npm audit --audit-level=moderate --json > audit-results.json || true
          cat audit-results.json
        continue-on-error: true
        
      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: audit-results.json
          retention-days: 30
          
      - name: Run Snyk Security Scan
        id: snyk-scan
        uses: snyk/actions/node@0.4.0
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-extended
          
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"
          
      - name: Check for outdated dependencies
        run: |
          echo "## Outdated Dependencies" > outdated.md
          npm outdated >> outdated.md || true
          cat outdated.md
          
      - name: Upload outdated dependencies report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies
          path: outdated.md
          retention-days: 30
          
      - name: Create security issue (if vulnerabilities found)
        if: always()
        uses: actions/github-script@v7
        env:
          SNYK_OUTCOME: ${{ steps.snyk-scan.outcome }}
        with:
          script: |
            const fs = require('fs');
            let auditResults = {};
            try {
              auditResults = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
            } catch (e) {
              console.log('Could not parse audit results');
            }

            const vulnerabilityCount = auditResults.metadata?.vulnerabilities || {};
            const totalVulnerabilities = Object.values(vulnerabilityCount).reduce((a, b) => a + b, 0);
            const snykOutcome = process.env.SNYK_OUTCOME;
            const hasAuditFindings = totalVulnerabilities > 0;
            const hasSnykFindings = snykOutcome === 'failure';

            if (hasAuditFindings || hasSnykFindings) {
              const issueTitle = hasAuditFindings
                ? `ðŸ”’ Weekly Security Audit - ${totalVulnerabilities} vulnerabilities found`
                : 'ðŸ”’ Weekly Security Audit - Review Snyk findings';

              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: `## Security Audit Results\n\n**Date**: ${new Date().toISOString()}\n\n**npm audit vulnerabilities**:\n${Object.entries(vulnerabilityCount).map(([k, v]) => `- ${k}: ${v}`).join('\n') || '- None reported'}\n\n**Snyk scan status**: ${hasSnykFindings ? 'Action required' : 'No issues detected'}\n\nPlease review the attached artifacts for detailed information.`,
                labels: ['security', 'automated']
              });
            }
