name: Next.js Health Check

on:
  pull_request:
    paths:
      - 'src/**'
      - 'app/**'
      - 'pages/**'
      - 'next.config.ts'
      - 'next.config.js'
      - 'package.json'
  workflow_dispatch:

# Prevent multiple runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nextjs-health-check:
    name: Next.js Configuration & Best Practices
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Check Next.js version
        run: |
          echo "Checking Next.js version..."
          NEXT_VERSION=$(node -p "require('./package.json').dependencies.next")
          echo "Next.js version: $NEXT_VERSION"
          
          # Check if using Next.js 15.5+
          MAJOR=$(echo $NEXT_VERSION | cut -d. -f1 | tr -d '^~')
          MINOR=$(echo $NEXT_VERSION | cut -d. -f2)
          
          if [ "$MAJOR" -ge 15 ] && [ "$MINOR" -ge 5 ]; then
            echo "âœ… Using Next.js 15.5+ - Good for production"
          elif [ "$MAJOR" -ge 15 ]; then
            echo "âš ï¸  Using Next.js 15.$MINOR - Consider upgrading to 15.5+"
          else
            echo "âš ï¸  Not using Next.js 15+"
          fi
          
      - name: Verify App Router usage
        run: |
          echo "Checking for App Router structure..."
          if [ -d "src/app" ] || [ -d "app" ]; then
            echo "âœ… Using App Router"
            
            # Check for proper async handling in Next.js 15
            echo ""
            echo "Checking for proper params/searchParams handling..."
            
            # Look for potential issues with params/searchParams not being awaited
            if grep -r "params\." src/app 2>/dev/null | grep -v "await params" | grep -v "params.then" | head -5; then
              echo "âš ï¸  Found potential params usage without await"
              echo "ðŸ’¡ In Next.js 15, params and searchParams must be awaited"
              echo "   Example: const { id } = await params"
            else
              echo "âœ… Params handling looks good"
            fi
          else
            echo "âš ï¸  Not using App Router (pages directory detected)"
          fi
          
      - name: Check for deprecated patterns
        run: |
          echo "Checking for deprecated Next.js patterns..."
          
          # Check for getServerSideProps in App Router
          if [ -d "src/app" ] || [ -d "app" ]; then
            if grep -r "getServerSideProps\|getStaticProps\|getStaticPaths" src/app app 2>/dev/null | head -3; then
              echo "âš ï¸  Found Pages Router methods in App Router directory"
              echo "ðŸ’¡ Use Server Components and fetch directly instead"
            else
              echo "âœ… No deprecated data fetching methods found"
            fi
          fi
          
          # Check for old image import patterns
          if grep -r "next/legacy/image" src 2>/dev/null | head -3; then
            echo "âš ï¸  Found legacy Image imports"
            echo "ðŸ’¡ Use 'next/image' instead of 'next/legacy/image'"
          fi
          
      - name: Verify Cloudflare Pages compatibility
        run: |
          echo "Checking Cloudflare Pages compatibility..."
          
          # Check for Node.js runtime in edge functions
          if grep -r "export const runtime = 'nodejs'" src/app 2>/dev/null | head -3; then
            echo "âš ï¸  Found nodejs runtime export"
            echo "ðŸ’¡ Cloudflare Pages uses Edge Runtime - use 'edge' runtime instead"
          else
            echo "âœ… No problematic runtime exports found"
          fi
          
          # Check for unsupported Node.js APIs
          UNSUPPORTED_APIS="fs.readFile\|fs.writeFile\|child_process\|crypto.randomBytes"
          if grep -r "$UNSUPPORTED_APIS" src 2>/dev/null | grep -v node_modules | head -5; then
            echo "âš ï¸  Found potential Node.js API usage that may not work on Edge Runtime"
            echo "ðŸ’¡ Use Web APIs or ensure code runs in Node.js-compatible context"
          else
            echo "âœ… No obvious Edge Runtime incompatibilities"
          fi
          
      - name: Check build configuration
        run: |
          echo "Checking Next.js configuration..."
          
          if [ -f "next.config.ts" ] || [ -f "next.config.js" ]; then
            echo "âœ… Next.js config file found"
            
            # Check for Turbopack readiness
            if grep -q "turbopack" package.json; then
              echo "âœ… Project uses Turbopack in dev mode"
            fi
            
            # Check for image optimization settings
            if grep -q "unoptimized.*true" next.config.* 2>/dev/null; then
              echo "âš ï¸  Image optimization disabled (unoptimized: true)"
              echo "ðŸ’¡ Consider using Cloudflare Images for optimization"
            fi
          else
            echo "âš ï¸  No Next.js config file found"
          fi
          
      - name: Analyze bundle potential
        run: |
          echo "Analyzing potential bundle optimizations..."
          
          # Check for large dependencies
          echo "Large dependencies that might benefit from optimization:"
          npm list --depth=0 --json 2>/dev/null | jq -r '.dependencies | to_entries[] | select(.key | test("moment|lodash|date-fns")) | .key' || true
          
          # Check for dynamic imports
          DYNAMIC_IMPORTS=$(grep -r "import(" src 2>/dev/null | wc -l || echo "0")
          echo ""
          echo "Dynamic imports found: $DYNAMIC_IMPORTS"
          if [ "$DYNAMIC_IMPORTS" -gt 0 ]; then
            echo "âœ… Using code splitting"
          else
            echo "ðŸ’¡ Consider using dynamic imports for better code splitting"
          fi
          
      - name: Generate recommendations
        run: |
          echo ""
          echo "==================================="
          echo "ðŸ“‹ Next.js Health Check Summary"
          echo "==================================="
          echo ""
          echo "âœ… Configuration validated"
          echo "âœ… App Router structure checked"
          echo "âœ… Cloudflare compatibility verified"
          echo ""
          echo "For detailed recommendations, check the logs above."
          echo ""
