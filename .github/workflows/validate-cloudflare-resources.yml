name: Validate Cloudflare Resources

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  validate-r2-storage:
    name: Validate R2 Storage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Wrangler
        run: npm install -g wrangler
        
      - name: Check R2 bucket configuration
        run: |
          echo "Checking R2 bucket configuration from wrangler.toml..."
          if [ -f "wrangler.toml" ]; then
            cat wrangler.toml
          else
            echo "Warning: wrangler.toml not found"
          fi
          
      - name: Validate R2 bucket access
        if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' }}
        run: |
          # List R2 buckets (if API token is available)
          wrangler r2 bucket list || echo "Could not list R2 buckets - check API token permissions"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
  validate-kv-namespace:
    name: Validate KV Namespace
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Wrangler
        run: npm install -g wrangler
        
      - name: Validate KV namespace access
        if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' }}
        run: |
          # List KV namespaces (if API token is available)
          wrangler kv:namespace list || echo "Could not list KV namespaces - check API token permissions"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
  validate-csv-data:
    name: Validate CSV Data Integrity
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Validate CSV files
        run: |
          echo "Checking CSV data files..."
          
          # Check if CSV files exist
          if [ ! -f "data/akyo-data.csv" ]; then
            echo "Error: data/akyo-data.csv not found"
            exit 1
          fi
          
          if [ ! -f "data/akyo-data-US.csv" ]; then
            echo "Error: data/akyo-data-US.csv not found"
            exit 1
          fi
          
          # Count records in CSV files
          JA_RECORDS=$(tail -n +2 data/akyo-data.csv | wc -l)
          EN_RECORDS=$(tail -n +2 data/akyo-data-US.csv | wc -l)
          
          echo "Japanese CSV records: ${JA_RECORDS}"
          echo "English CSV records: ${EN_RECORDS}"
          
          # Basic validation: both files should have similar record counts
          if [ $JA_RECORDS -eq 0 ]; then
            echo "Error: Japanese CSV is empty"
            exit 1
          fi
          
          if [ $EN_RECORDS -eq 0 ]; then
            echo "Error: English CSV is empty"
            exit 1
          fi
          
          echo "‚úÖ CSV data validation passed"
          
  create-health-check-report:
    name: Create Health Check Report
    runs-on: ubuntu-latest
    needs: [validate-r2-storage, validate-kv-namespace, validate-csv-data]
    if: always()
    
    steps:
      - name: Create health report
        uses: actions/github-script@v7
        with:
          script: |
            const r2Status = '${{ needs.validate-r2-storage.result }}';
            const kvStatus = '${{ needs.validate-kv-namespace.result }}';
            const csvStatus = '${{ needs.validate-csv-data.result }}';
            
            const statusEmoji = (status) => status === 'success' ? '‚úÖ' : '‚ùå';
            
            const report = `## üìä Cloudflare Resources Health Check
            
            **Date**: ${new Date().toISOString()}
            
            ### Status Summary
            - ${statusEmoji(r2Status)} R2 Storage: ${r2Status}
            - ${statusEmoji(kvStatus)} KV Namespace: ${kvStatus}
            - ${statusEmoji(csvStatus)} CSV Data: ${csvStatus}
            
            ### Next Steps
            ${r2Status !== 'success' ? '- ‚ö†Ô∏è Check R2 bucket configuration and API token\n' : ''}
            ${kvStatus !== 'success' ? '- ‚ö†Ô∏è Check KV namespace configuration and API token\n' : ''}
            ${csvStatus !== 'success' ? '- ‚ö†Ô∏è Verify CSV data files in data/ directory\n' : ''}
            ${r2Status === 'success' && kvStatus === 'success' && csvStatus === 'success' ? '‚úÖ All resources are healthy!\n' : ''}
            `;
            
            console.log(report);
