name: Sync JSON Data from CSV

# =============================================================================
# CSV to JSON Sync Workflow
# =============================================================================
# This workflow automatically converts CSV data files to JSON format and
# uploads them to Cloudflare R2 for optimized data fetching (Phase 4).
#
# Required Secrets:
#   - R2_ACCESS_KEY_ID: Cloudflare R2 Access Key ID
#     (Create at: Cloudflare Dashboard â†’ R2 â†’ Manage R2 API Tokens)
#   - R2_SECRET_ACCESS_KEY: Cloudflare R2 Secret Access Key
#     (Displayed only once when creating the R2 API token)
#   - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare Account ID
#     (Found in: Cloudflare Dashboard â†’ R2 â†’ Overview, or in the URL)
#   - REVALIDATE_SECRET: Secret token for on-demand ISR revalidation
#     (Generate a random string, e.g., `openssl rand -hex 32`)
#
# R2 Bucket Structure:
#   akyo-images/
#   â”œâ”€â”€ data/
#   â”‚   â”œâ”€â”€ akyo-data-ja.json  (Japanese data)
#   â”‚   â””â”€â”€ akyo-data-en.json  (English data)
#   â””â”€â”€ images/
#       â””â”€â”€ *.webp (avatar images)
#
# Public URL: https://images.akyodex.com/data/akyo-data-{lang}.json
# =============================================================================

on:
  push:
    branches:
      - main
    paths:
      - 'data/akyo-data.csv'
      - 'data/akyo-data-US.csv'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  R2_BUCKET: akyo-images
  R2_DATA_PATH: data
  JSON_FILE_JA: akyo-data-ja.json
  JSON_FILE_EN: akyo-data-en.json
  SITE_URL: https://akyodex.com

jobs:
  sync-json:
    name: Convert CSV to JSON and Upload to R2
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Convert CSV to JSON
        run: |
          set -e
          echo "Converting CSV files to JSON..."
          if ! npm run data:convert; then
            echo "::error::CSV to JSON conversion failed"
            exit 1
          fi
          echo "âœ… CSV to JSON conversion completed successfully"

      - name: Check for JSON changes
        id: json-changes
        run: |
          set -e
          JSON_JA="data/${{ env.JSON_FILE_JA }}"
          JSON_EN="data/${{ env.JSON_FILE_EN }}"
          if git diff --quiet -- "$JSON_JA" "$JSON_EN"; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No JSON changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "JSON changes detected:"
            git diff --stat -- "$JSON_JA" "$JSON_EN"
          fi

      - name: Commit JSON changes
        if: steps.json-changes.outputs.changed == 'true'
        run: |
          set -e
          JSON_JA="data/${{ env.JSON_FILE_JA }}"
          JSON_EN="data/${{ env.JSON_FILE_EN }}"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -- "$JSON_JA" "$JSON_EN"
          git commit -m "chore: auto-sync JSON data from CSV changes"
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          RETRY_DELAY=5
          LAST_FAILURE=""
          LAST_EXIT_CODE=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            set +e
            git push
            PUSH_EXIT_CODE=$?
            set -e
            if [ $PUSH_EXIT_CODE -eq 0 ]; then
              echo "âœ… Git push successful (attempt $RETRY_COUNT/$MAX_RETRIES)"
              exit 0
            fi
            LAST_FAILURE="push"
            LAST_EXIT_CODE=$PUSH_EXIT_CODE
            echo "::warning::git push failed (attempt $RETRY_COUNT/$MAX_RETRIES): exit code $PUSH_EXIT_CODE"
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
              set +e
              git pull --rebase
              REBASE_EXIT_CODE=$?
              set -e
              if [ $REBASE_EXIT_CODE -ne 0 ]; then
                LAST_FAILURE="rebase"
                LAST_EXIT_CODE=$REBASE_EXIT_CODE
                echo "::warning::git pull --rebase failed (attempt $RETRY_COUNT/$MAX_RETRIES): exit code $REBASE_EXIT_CODE"
                git rebase --abort 2>/dev/null || true
              else
                echo "âœ… git pull --rebase successful (attempt $RETRY_COUNT/$MAX_RETRIES)"
              fi
            fi
          done
          echo "::error::Git sync failed after $MAX_RETRIES attempts. Last failure: git $LAST_FAILURE (exit code $LAST_EXIT_CODE)"
          exit 1

      - name: Upload JSON to Cloudflare R2
        if: steps.json-changes.outputs.changed == 'true'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -e
          echo "Validating required secrets..."
          MISSING_SECRETS=""
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}R2_ACCESS_KEY_ID "
          fi
          if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}R2_SECRET_ACCESS_KEY "
          fi
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}CLOUDFLARE_ACCOUNT_ID "
          fi
          if [ -n "$MISSING_SECRETS" ]; then
            echo "::error::Missing required secrets: $MISSING_SECRETS"
            exit 1
          fi
          echo "âœ… All required secrets are configured"
          
          R2_ENDPOINT="https://${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com"
          
          echo "Verifying R2 bucket access..."
          if ! aws s3 ls "s3://${{ env.R2_BUCKET }}/" --endpoint-url "$R2_ENDPOINT" > /dev/null 2>&1; then
            echo "::error::Cannot access R2 bucket '${{ env.R2_BUCKET }}'"
            exit 1
          fi
          echo "âœ… R2 bucket is accessible"
          
          echo "Uploading JSON files to R2..."
          UPLOAD_FAILED=false
          
          JSON_JA_PATH="data/${{ env.JSON_FILE_JA }}"
          R2_JA_PATH="s3://${{ env.R2_BUCKET }}/${{ env.R2_DATA_PATH }}/${{ env.JSON_FILE_JA }}"
          echo "Uploading $JSON_JA_PATH to $R2_JA_PATH..."
          if aws s3 cp "$JSON_JA_PATH" "$R2_JA_PATH" --endpoint-url "$R2_ENDPOINT" --content-type "application/json"; then
            echo "âœ… Uploaded ${{ env.JSON_FILE_JA }}"
          else
            echo "::error::Failed to upload ${{ env.JSON_FILE_JA }}"
            UPLOAD_FAILED=true
          fi
          
          JSON_EN_PATH="data/${{ env.JSON_FILE_EN }}"
          R2_EN_PATH="s3://${{ env.R2_BUCKET }}/${{ env.R2_DATA_PATH }}/${{ env.JSON_FILE_EN }}"
          echo "Uploading $JSON_EN_PATH to $R2_EN_PATH..."
          if aws s3 cp "$JSON_EN_PATH" "$R2_EN_PATH" --endpoint-url "$R2_ENDPOINT" --content-type "application/json"; then
            echo "âœ… Uploaded ${{ env.JSON_FILE_EN }}"
          else
            echo "::error::Failed to upload ${{ env.JSON_FILE_EN }}"
            UPLOAD_FAILED=true
          fi
          
          if [ "$UPLOAD_FAILED" = true ]; then
            echo "::error::One or more uploads failed"
            exit 1
          fi
          echo "ðŸŽ‰ R2 upload complete!"

      - name: Trigger ISR Revalidation
        if: steps.json-changes.outputs.changed == 'true'
        env:
          REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}
        run: |
          set -e
          if [ -z "$REVALIDATE_SECRET" ]; then
            echo "::warning::REVALIDATE_SECRET not configured, skipping ISR revalidation"
            exit 0
          fi
          echo "Triggering ISR revalidation..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ env.SITE_URL }}/api/revalidate" \
            -H "Content-Type: application/json" \
            -H "x-revalidate-secret: $REVALIDATE_SECRET" \
            -d '{"paths": ["/", "/en"], "tags": ["akyo-data", "akyo-data-ja", "akyo-data-en"], "updateKV": true}' \
            --max-time 60)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… ISR revalidation successful"
            echo "Response: $BODY"
          else
            echo "::warning::ISR revalidation failed (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
          fi

      - name: Summary
        run: |
          echo "## JSON Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.json-changes.outputs.changed }}" == "true" ]; then
            echo "âœ… JSON files updated and uploaded to R2" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Updated Files" >> $GITHUB_STEP_SUMMARY
            echo "- \`data/${{ env.JSON_FILE_JA }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`data/${{ env.JSON_FILE_EN }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### R2 URLs" >> $GITHUB_STEP_SUMMARY
            echo "- https://images.akyodex.com/${{ env.R2_DATA_PATH }}/${{ env.JSON_FILE_JA }}" >> $GITHUB_STEP_SUMMARY
            echo "- https://images.akyodex.com/${{ env.R2_DATA_PATH }}/${{ env.JSON_FILE_EN }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Cache Invalidation" >> $GITHUB_STEP_SUMMARY
            echo "- ISR revalidation triggered for instant updates" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes detected in JSON files" >> $GITHUB_STEP_SUMMARY
          fi
