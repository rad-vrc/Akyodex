name: Sync JSON Data from CSV

# Trigger on CSV file changes in main branch
on:
  push:
    branches:
      - main
    paths:
      - 'data/akyo-data.csv'
      - 'data/akyo-data-US.csv'

# Allow manual trigger
  workflow_dispatch:

# Prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-json:
    name: Convert CSV to JSON and Upload to R2
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Convert CSV to JSON
        run: npm run data:convert
        
      - name: Check for JSON changes
        id: json-changes
        run: |
          if git diff --quiet data/*.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No JSON changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "JSON changes detected:"
            git diff --stat data/*.json
          fi
          
      - name: Commit JSON changes
        if: steps.json-changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/akyo-data-ja.json data/akyo-data-en.json
          git commit -m "chore: auto-sync JSON data from CSV changes"
          git push
          
      - name: Upload JSON to Cloudflare R2
        if: steps.json-changes.outputs.changed == 'true'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
        run: |
          echo "Uploading JSON files to R2..."
          
          # Upload Japanese JSON
          aws s3 cp data/akyo-data-ja.json s3://akyo-images/data/akyo-data-ja.json \
            --endpoint-url "$R2_ENDPOINT" \
            --content-type "application/json"
          echo "âœ… Uploaded akyo-data-ja.json"
          
          # Upload English JSON
          aws s3 cp data/akyo-data-en.json s3://akyo-images/data/akyo-data-en.json \
            --endpoint-url "$R2_ENDPOINT" \
            --content-type "application/json"
          echo "âœ… Uploaded akyo-data-en.json"
          
          echo "ðŸŽ‰ R2 upload complete!"
          
      - name: Summary
        run: |
          echo "## JSON Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.json-changes.outputs.changed }}" == "true" ]; then
            echo "âœ… JSON files updated and uploaded to R2" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Updated Files" >> $GITHUB_STEP_SUMMARY
            echo "- \`data/akyo-data-ja.json\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`data/akyo-data-en.json\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes detected in JSON files" >> $GITHUB_STEP_SUMMARY
          fi
