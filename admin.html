<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akyoずかん - ファインダーモード</title>
    <link rel="icon" type="image/png" sizes="32x32" href="images/akyodexIcon-32.png?v=20250926">
    <link rel="icon" type="image/png" sizes="16x16" href="images/akyodexIcon-16.png?v=20250926">
    <!-- iOSアイコン -->
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon-180.png">


    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <!-- 子どもにやさしいデザイン -->
    <link rel="stylesheet" href="css/kid-friendly.css?v=20250927">

    <!-- ストレージファインダー -->
    <script src="js/storage-manager.js"></script>
    <script src="js/storage-adapter.js"></script>

    <style>
        body {
            font-family: 'Noto Sans JP', 'Kosugi Maru', sans-serif;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .drop-zone {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }

        .drop-zone.dragover {
            border-color: #667eea;
            background-color: #f7fafc;
        }

        #addCreatorSuggestions {
            overflow-y: auto;
            overflow-x: hidden;
        }

        body:not(.finder-body) #addCreatorSuggestions {
            background-color: #fff;
            border: 1px solid rgba(209, 213, 219, 0.9);
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.12);
        }

        body:not(.finder-body) #addCreatorSuggestions::before {
            content: none;
        }

        #addCreatorSuggestions::-webkit-scrollbar:horizontal {
            height: 0;
            display: none;
        }

        #editModal h2 {
            background: none !important;
            color: var(--text-primary, #1f2937) !important;
            text-shadow: none !important;
            animation: none !important;
            -webkit-text-fill-color: currentColor !important;
            -webkit-background-clip: border-box !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen">
    <!-- ヘッダー -->
    <header class="bg-gray-900 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-red-500 to-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-shield-alt text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold">Akyoずかん ファインダーモード</h1>
                </div>

                <div class="flex items-center gap-2">
                    <span id="userRole" class="hidden px-3 py-2 rounded-lg bg-gray-700 text-white text-sm"></span>
                    <button onclick="location.href='index.html'" class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white text-sm" id="backBtn">
                        <i class="fas fa-home mr-1"></i> 図鑑に戻る
                    </button>
                    <button onclick="logout()" class="hidden px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white text-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt mr-1"></i> ログアウト
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ログイン画面 -->
    <div id="loginScreen" class="flex items-center justify-center min-h-[calc(100vh-80px)]">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-red-500 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-lock text-white text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">ファインダー認証</h2>
                <p class="text-gray-600 text-sm">Akyoワードを入力してファインダー機能にアクセス</p>
            </div>

            <form id="finderLoginForm">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Akyoワード</label>
                    <input
                        type="password"
                        id="passwordInput"
                        name="password"
                        autocomplete="current-password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                        placeholder="Akyoワードを入力"
                        required
                    >
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-red-500 to-orange-500 text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity">
                    <i class="fas fa-sign-in-alt mr-2"></i> ログイン
                </button>

                <div id="loginError" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm" role="alert" aria-live="assertive">
                    <i class="fas fa-exclamation-circle mr-1"></i> Akyoワードが正しくありません
                </div>
            </form>
            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-gray-700">
                <p class="font-semibold mb-2">見つけたAkyoを登録したい？</p>
                <p class="mb-2">次のいずれかのアカウント宛に：</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><a href="https://x.com/rad_vrc" target="_blank" rel="noopener" class="text-blue-600 underline hover:text-blue-800">らど https://x.com/rad_vrc</a></li>
                    <li><a href="https://x.com/nknmnThe_VRC" target="_blank" rel="noopener" class="text-blue-600 underline hover:text-blue-800">ネコノミ https://x.com/nknmnThe_VRC</a></li>
                    <li><a href="https://x.com/KAYA_Vchat" target="_blank" rel="noopener" class="text-blue-600 underline hover:text-blue-800">カヤ https://x.com/KAYA_Vchat</a></li>
                    <li><a href="https://x.com/zhoney666" target="_blank" rel="noopener" class="text-blue-600 underline hover:text-blue-800">ジョニー https://x.com/zhoney666</a></li>
                </ul>
                <p class="mt-2">「ひみつのAkyoワードを教えて」とメッセージを送ってみてね！</p>
            </div>
        </div>
    </div>

    <!-- ファインダー画面 -->
    <div id="adminScreen" class="hidden container mx-auto px-4 py-8">
        <!-- タブナビゲーション -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="flex border-b">
                <button onclick="switchTab('add')" class="tab-btn tab-active px-6 py-4 font-medium text-gray-700" data-tab="add">
                    <i class="fas fa-plus-circle"></i>
                    新規登録
                </button>
                <button onclick="switchTab('edit')" class="tab-btn px-6 py-4 font-medium text-gray-700" data-tab="edit">
                    <i class="fas fa-edit"></i>
                    編集・削除
                </button>
                <button onclick="switchTab('tools')" class="tab-btn px-6 py-4 font-medium text-gray-700" data-tab="tools">
                    <i class="fas fa-tools"></i>
                    ツール
                </button>
            </div>
        </div>

        <!-- 新規登録タブ -->
        <div id="addTab" class="tab-content bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-plus-circle admin-accent-text mr-2"></i> 新しいAkyoを登録
            </h2>

            <form onsubmit="handleAddAkyo(event)" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">ID（自動採番）</label>
                        <input type="text" id="nextIdDisplay"
                               class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg font-mono font-bold"
                               disabled>
                        <p class="mt-2 text-xs text-gray-500 leading-snug">
                            画像IDの自動割り当てはローカルに保存された画像を優先的に参照し、未使用の番号（CSV未登録の画像も含む）から決定されます。
                        </p>
                    </div>

                    <div>
                        <div class="flex items-center justify-between gap-2">
                            <label class="block text-gray-700 text-sm font-medium">通称</label>
                            <button type="button" id="checkNicknameDuplicateButton"
                                    class="inline-flex items-center gap-2 px-3 py-1.5 text-sm border border-orange-200 text-orange-700 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors">
                                <i class="fas fa-search"></i>
                                同じ通称が既に登録されているか確認
                            </button>
                        </div>
                        <input type="text" name="nickname" id="addNicknameInput"
                               class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                               placeholder="例: チョコミントAkyo">
                        <p id="nicknameDuplicateStatus" class="mt-2 text-sm hidden" data-status-base-class="mt-2 text-sm" aria-live="polite"></p>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">アバター名</label>
                        <input type="text" name="avatarName" id="addAvatarNameInput" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                               placeholder="例: Akyo origin">
                        <div class="mt-2 flex flex-col sm:flex-row sm:items-center gap-2">
                            <button type="button" id="checkAvatarDuplicateButton"
                                    class="inline-flex items-center gap-2 px-3 py-1.5 text-sm border border-orange-200 text-orange-700 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors">
                                <i class="fas fa-search"></i>
                                同じアバター名が既に登録されているか確認
                            </button>
                            <p id="avatarDuplicateStatus" class="text-sm hidden mt-1 sm:mt-0 sm:ml-2" data-status-base-class="text-sm mt-1 sm:mt-0 sm:ml-2" aria-live="polite"></p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">属性</label>
                        <div class="space-y-2">
                            <button type="button"
                                    class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-green-100 text-green-800 border border-green-300 rounded-lg hover:bg-green-200 transition-colors"
                                    data-attribute-target="add">
                                <i class="fas fa-tags"></i>
                                属性を管理
                            </button>
                            <input type="hidden" name="attribute" id="addAttributeInput">
                            <div class="border border-dashed border-green-200 rounded-lg bg-white/60 p-3">
                                <p id="addAttributePlaceholder" class="text-sm text-gray-500">
                                    選択された属性がここに表示されます
                                </p>
                                <div id="addAttributeList"
                                     class="hidden mt-2 flex flex-wrap gap-2 max-h-32 overflow-y-auto pr-1"
                                     role="list"></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">作者</label>
                        <div class="relative" data-author-autocomplete>
                            <input type="text" name="creator" id="addCreatorInput" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                                   placeholder="例: ugai" autocomplete="off">
                            <div id="addCreatorSuggestions"
                                 class="hidden absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto z-30"
                                 role="listbox" aria-label="既存の作者から選択" aria-hidden="true"></div>
                        </div>
                    </div>

                    <div>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-1">
                            <label class="text-gray-700 text-sm font-medium">VRChat URL</label>
                            <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                                <button type="button" id="fetchAvatarNameFromVrchat"
                                        class="px-3 py-1.5 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-lg transition-colors duration-200 flex items-center gap-1.5 justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                                        title="VRChat URLからアバター名を自動取得">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                    </svg>
                                    <span>URLからアバター名を取得</span>
                                </button>
                                <button type="button" id="fetchImageFromVrchat"
                                        class="px-3 py-1.5 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-lg transition-colors duration-200 flex items-center gap-1.5 justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                                        title="VRChat URLから画像を自動取得">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                    </svg>
                                    <span>URLから画像を取得</span>
                                </button>
                            </div>
                        </div>
                        <input type="url" name="avatarUrl" id="avatarUrlInput"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                               placeholder="https://vrchat.com/...">
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">備考</label>
                    <textarea name="notes" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                              placeholder="Quest対応、特殊機能など"></textarea>
                </div>

                <!-- 画像アップロード -->
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">画像</label>
                    <div class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center" id="imageDropZone">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">画像をドラッグ&ドロップ または</p>
                        <input type="file" id="imageInput" accept=".webp,.png,.jpg,.jpeg" class="hidden">
                        <button type="button" onclick="document.getElementById('imageInput').click()"
                                class="mt-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            ファイルを選択
                        </button>

                        <!-- プレビューとトリミングエリア -->
                        <div id="imagePreview" class="mt-4 hidden">
                            <div class="bg-gray-100 rounded-lg p-4">
                                <div class="mb-3 text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ドラッグで位置調整、スクロールで拡大縮小できます
                                </div>

                                <!-- トリミングコンテナ -->
                                <div id="cropContainer" class="relative mx-auto mb-4" style="width: 300px; height: 200px; overflow: hidden; border: 2px solid #4f46e5; border-radius: 8px;">
                                    <img id="cropImage" src="" alt="Crop preview"
                                         style="position: absolute; cursor: move; transform-origin: center;">
                                </div>

                                <!-- コントロールボタン -->
                                <div class="flex justify-center gap-2">
                                    <button type="button" onclick="resetImagePosition()"
                                            class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm">
                                        <i class="fas fa-redo mr-1"></i> リセット
                                    </button>
                                    <button type="button" onclick="zoomImage(1.1)"
                                            class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                        <i class="fas fa-search-plus mr-1"></i> 拡大
                                    </button>
                                    <button type="button" onclick="zoomImage(0.9)"
                                            class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                        <i class="fas fa-search-minus mr-1"></i> 縮小
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">登録すると画像も公開環境へ自動でアップロードされ、図鑑でもすぐ表示されます（対応形式: WebP / PNG / JPG）。</p>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity">
                    <i class="fas fa-save mr-2"></i> 登録する
                </button>
            </form>
        </div>

        <!-- 編集・削除タブ -->
        <div id="editTab" class="tab-content hidden bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-edit text-blue-500 mr-2"></i> Akyoの編集・削除※削除はらどのみ可能です
            </h2>

            <!-- 検索 -->
            <div class="mb-6">
                <div class="relative">
                    <input type="text" id="editSearchInput"
                           placeholder="ID、名前、属性で検索..."
                           class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                </div>
            </div>

            <!-- 編集リスト -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ID</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">名前</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">属性</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">作者</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">操作</th>
                        </tr>
                    </thead>
                    <tbody id="editList" class="divide-y divide-gray-200">
                        <!-- データはJavaScriptで動的に追加 -->
                    </tbody>
                </table>
            </div>
        </div>





        <!-- ツールタブ -->
        <div id="toolsTab" class="tab-content hidden bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-tools text-orange-500 mr-2"></i> ファインダーツール
            </h2>

            <div class="space-y-6">
                <!-- ID再採番ツール -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">
                        <i class="fas fa-sort-numeric-down text-blue-500 mr-2"></i> ID再採番
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        すべてのAkyoのIDを001から連番で振り直します。<br>
                        ※ 画像とお気に入りの紐付けも自動で更新されます。
                    </p>
                    <button onclick="renumberAllIds()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        <i class="fas fa-redo mr-2"></i> ID再採番を実行
                    </button>
                </div>

                <!-- CSVインポート -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">
                        <i class="fas fa-file-upload text-orange-500 mr-2"></i> CSVインポート（追加登録）
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        CSVファイルからAkyoデータを追加登録します。アップロード前に最初の数件をプレビューします。<br>
                        対応形式: .csv（MIME: text/csv, application/vnd.ms-excel, text/plain なども許容）
                    </p>

                    <!-- ドロップゾーン -->
                    <div id="csvDropZone" class="drop-zone rounded-lg p-6 text-center mb-4">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">CSVファイルをドラッグ&ドロップ または</p>
                        <input type="file" id="csvInput" accept=".csv,text/csv,text/plain,application/vnd.ms-excel" class="hidden">
                        <button type="button" onclick="document.getElementById('csvInput').click()"
                                class="mt-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            ファイルを選択
                        </button>
                    </div>

                    <!-- プレビュー -->
                    <div id="csvPreview" class="hidden">
                        <div class="bg-gray-50 rounded-lg p-3 mb-3 text-sm text-gray-600">
                            ヘッダー行は無視し、既存データの最大IDから自動採番して追加されます。
                        </div>
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="min-w-full text-sm" id="csvPreviewTable"></table>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="uploadCSV()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                                <i class="fas fa-check mr-2"></i> この内容で登録
                            </button>
                            <button type="button" onclick="document.getElementById('csvPreview').classList.add('hidden'); document.getElementById('csvInput').value='';" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                クリア
                            </button>
                        </div>
                    </div>
                </div>




            </div>
        </div>
    </div>

    <!-- 編集モーダル -->
    <div id="editModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                    <h2 class="text-2xl font-bold flex items-center">
                        <i class="fas fa-edit text-blue-500 mr-2"></i>
                        Akyoを編集
                    </h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div id="editModalContent" class="p-6">
                    <!-- 編集フォーム -->
                    <!-- 画像アップロード（編集用） -->
<div class="mt-6">
    <label class="block text-gray-700 text-sm font-medium mb-1">画像（編集）</label>


    <!-- ドロップゾーン -->
    <div id="editImageDropZone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
    <p class="text-gray-600">画像をドラッグ&ドロップ または</p>
    <input type="file" id="editImageInput" accept=".webp,.png,.jpg,.jpeg" class="hidden">
    <button type="button" onclick="document.getElementById('editImageInput').click()"
    class="mt-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
    ファイルを選択
    </button>
    <p class="text-xs text-gray-500 mt-2">推奨: 300×200px / .webp .png .jpg .jpeg</p>
    </div>


    <!-- プレビュー＆トリミング（編集用） -->
    <div id="editImagePreview" class="mt-4 hidden">
    <div class="bg-gray-100 rounded-lg p-4">
    <div class="mb-3 text-sm text-gray-600">
    <i class="fas fa-info-circle mr-1"></i>
    ドラッグで位置調整、ホイールで拡大縮小できます（編集用）
    </div>


    <!-- トリミングコンテナ（編集用） -->
    <div id="editCropContainer" class="relative w-full" style="aspect-ratio: 3/2; overflow: hidden; border: 2px solid #4f46e5; border-radius: 8px;">
    <img id="editCropImage" src="" alt="Crop preview (edit)" style="position: absolute; cursor: move; transform-origin: top left;">
    </div>


    <div class="flex justify-center gap-2 mt-3">
    <button type="button" onclick="resetEditImagePosition()"
    class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm">
    <i class="fas fa-redo mr-1"></i> リセット
    </button>
    <button type="button" onclick="zoomEditImage(1.1)"
    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
    <i class="fas fa-search-plus mr-1"></i> 拡大
    </button>
    <button type="button" onclick="zoomEditImage(0.9)"
    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
    <i class="fas fa-search-minus mr-1"></i> 縮小
    </button>
    </div>
    </div>
    </div>
    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 属性管理モーダル -->
    <div id="attributeModal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="attributeModalTitle">
        <div class="absolute inset-0 bg-black/40" data-attribute-overlay></div>
        <div class="relative z-10 flex min-h-full items-center justify-center px-4 py-8 sm:py-12">
            <div class="w-full max-w-3xl">
                <div class="bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[calc(100vh-3rem)] sm:max-h-[calc(100vh-5rem)]">
                    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50">
                        <h3 id="attributeModalTitle" class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-tags text-green-500"></i>
                            属性を管理
                        </h3>
                        <button type="button" class="text-gray-500 hover:text-gray-700" data-attribute-close>
                        <span class="sr-only">閉じる</span>
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="px-6 py-5 space-y-5 flex-1 overflow-y-auto">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="search" id="attributeSearchInput"
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                   placeholder="属性を検索">
                        </div>
                        <button type="button" id="attributeCreateStart"
                                class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg border border-green-300 bg-green-100 text-green-800 hover:bg-green-200 transition-colors">
                            <i class="fas fa-plus-circle"></i>
                            新しい属性を作成
                        </button>
                    </div>

                    <div id="attributeCreateForm" class="hidden bg-green-50 border border-green-200 rounded-xl p-4 space-y-3">
                        <div>
                            <label for="attributeNewInput" class="block text-sm font-medium text-green-900 mb-1">新しい属性名</label>
                            <input type="text" id="attributeNewInput"
                                   class="w-full px-3 py-2 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                   placeholder="例: チョコミント類">
                        </div>
                        <div class="flex items-center justify-end gap-2">
                            <button type="button" id="attributeCreateCancel"
                                    class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100">
                                キャンセル
                            </button>
                            <button type="button" id="attributeCreateConfirm"
                                    class="px-4 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600">
                                追加する
                            </button>
                        </div>
                    </div>

                    <div class="border border-gray-200 rounded-2xl">
                        <div id="attributeListScroll" class="max-h-72 overflow-y-auto pr-1" tabindex="0">
                            <div id="attributeListGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 p-3"></div>
                        </div>
                        <p id="attributeEmptyMessage" class="hidden px-4 pb-4 text-sm text-gray-500">一致する属性がありません。</p>
                    </div>
                </div>

                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3">
                    <button type="button" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100" data-attribute-close>
                        キャンセル
                    </button>
                    <button type="button" id="attributeApplyButton"
                            class="px-5 py-2 rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold shadow hover:opacity-90 transition-opacity">
                        選択を決定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/image-manifest-loader.js"></script>
    <script src="js/image-loader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.loadAkyoManifest) { window.loadAkyoManifest().catch(() => {}); }
        });
    </script>
    <script src="js/attribute-manager.js"></script>
    <script src="js/admin.js"></script>

    <script>
        // 画像トリミング用の変数
        let imageScale = 1;
        let imageX = 0;
        let imageY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let originalImageSrc = null;
        let recentlyDragged = false;

        // 画像位置のリセット（中央に戻す）
        function resetImagePosition() {
            imageScale = 1;
            const container = document.getElementById('cropContainer');
            const img = document.getElementById('cropImage');
            if (container && img) {
                const cw = container.offsetWidth;
                const ch = container.offsetHeight;
                const iw = img.offsetWidth;
                const ih = img.offsetHeight;
                imageX = (cw - iw) / 2;
                imageY = (ch - ih) / 2;
            } else {
                imageX = 0;
                imageY = 0;
            }
            updateImageTransform();
        }

        // 画像の拡大縮小
        function zoomImage(factor) {
            imageScale *= factor;
            imageScale = Math.max(0.5, Math.min(3, imageScale));
            updateImageTransform();
        }

        // 画像の変形を更新
        function updateImageTransform() {
            const img = document.getElementById('cropImage');
            if (img) {
                img.style.transform = `translate(${imageX}px, ${imageY}px) scale(${imageScale})`;
            }
        }

        // トリミング機能の初期化
        function initCropping() {
            const container = document.getElementById('cropContainer');
            const img = document.getElementById('cropImage');

            if (!container || !img) return;

            // マウスホイールでズーム
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                zoomImage(delta);
            });

            // ドラッグ開始
            img.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragStartX = e.clientX - imageX;
                dragStartY = e.clientY - imageY;
                img.style.cursor = 'grabbing';
            });

            // ドラッグ中
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    imageX = e.clientX - dragStartX;
                    imageY = e.clientY - dragStartY;
                    updateImageTransform();
                }
            });

            // ドラッグ終了
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    recentlyDragged = true;
                    setTimeout(() => { recentlyDragged = false; }, 150);
                    const img = document.getElementById('cropImage');
                    if (img) img.style.cursor = 'move';
                }
            });

            // タッチイベント（モバイル対応）
            img.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    isDragging = true;
                    dragStartX = e.touches[0].clientX - imageX;
                    dragStartY = e.touches[0].clientY - imageY;
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (isDragging && e.touches.length === 1) {
                    imageX = e.touches[0].clientX - dragStartX;
                    imageY = e.touches[0].clientY - dragStartY;
                    updateImageTransform();
                }
            });

            document.addEventListener('touchend', () => {
                if (isDragging) {
                    isDragging = false;
                    recentlyDragged = true;
                    setTimeout(() => { recentlyDragged = false; }, 150);
                }
            });
        }

        // 画像選択時の処理を上書き
        document.addEventListener('DOMContentLoaded', () => {
            const imageInput = document.getElementById('imageInput');
            if (imageInput) {
                imageInput.addEventListener('change', (event) => {
                    handleImageSelectWithCrop(event);
                });
            }

            // ドロップゾーンの設定も更新
            const dropZone = document.getElementById('imageDropZone');
            if (dropZone) {
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type.startsWith('image/')) {
                        handleImageFileWithCrop(files[0]);
                    }
                });
            }

            // VRChat URLからアバター名を取得ボタン（新規登録フォーム）
            const fetchNameBtn = document.getElementById('fetchAvatarNameFromVrchat');
            const avatarUrlInput = document.getElementById('avatarUrlInput');
            const avatarNameInput = document.querySelector('input[name="avatarName"]');

            if (fetchNameBtn && avatarUrlInput && avatarNameInput) {
                fetchNameBtn.addEventListener('click', async () => {
                    const url = avatarUrlInput.value.trim();
                    if (!url) {
                        alert('VRChat URLを入力してください');
                        return;
                    }

                    // avtr_xxx を抽出
                    const match = url.match(/avtr_[A-Za-z0-9-]+/);
                    if (!match) {
                        alert('有効なVRChatアバターURLを入力してください\n例: https://vrchat.com/home/avatar/avtr_xxx...');
                        return;
                    }

                    const avtrId = match[0];
                    fetchNameBtn.disabled = true;
                    const originalText = fetchNameBtn.innerHTML;
                    fetchNameBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>取得中...</span>';

                    try {
                        const response = await fetch(`/api/vrc-avatar-info?avtr=${avtrId}`);
                        if (!response.ok) {
                            throw new Error(`アバター情報取得に失敗しました: ${response.status}`);
                        }

                        const data = await response.json();

                        // アバター名を上書き
                        avatarNameInput.value = data.avatarName || '';

                        // 成功メッセージ
                        fetchNameBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>取得完了！</span>';
                        setTimeout(() => {
                            fetchNameBtn.innerHTML = originalText;
                            fetchNameBtn.disabled = false;
                        }, 2000);
                    } catch (error) {
                        console.error('VRChatアバター名取得エラー:', error);
                        alert('VRChatからアバター名を取得できませんでした。\nURLが正しいか、アバターが公開設定か確認してください。');
                        fetchNameBtn.innerHTML = originalText;
                        fetchNameBtn.disabled = false;
                    }
                });
            }

            // VRChat URLから画像を取得ボタン（新規登録フォーム）
            const fetchBtn = document.getElementById('fetchImageFromVrchat');
            if (fetchBtn && avatarUrlInput) {
                fetchBtn.addEventListener('click', async () => {
                    const url = avatarUrlInput.value.trim();
                    if (!url) {
                        alert('VRChat URLを入力してください');
                        return;
                    }

                    // avtr_xxx を抽出
                    const match = url.match(/avtr_[A-Za-z0-9-]+/);
                    if (!match) {
                        alert('有効なVRChatアバターURLを入力してください\n例: https://vrchat.com/home/avatar/avtr_xxx...');
                        return;
                    }

                    const avtrId = match[0];
                    fetchBtn.disabled = true;
                    const originalText = fetchBtn.innerHTML;
                    fetchBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>取得中...</span>';

                    try {
                        const response = await fetch(`/api/vrc-avatar-image?avtr=${avtrId}&w=1024`);
                        if (!response.ok) {
                            throw new Error(`画像取得に失敗しました: ${response.status}`);
                        }

                        const blob = await response.blob();
                        const file = new File([blob], `${avtrId}.webp`, { type: 'image/webp' });

                        // 既存の画像処理フローに統合
                        handleImageFileWithCrop(file);

                        // 成功メッセージ
                        fetchBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>取得完了！</span>';
                        setTimeout(() => {
                            fetchBtn.innerHTML = originalText;
                            fetchBtn.disabled = false;
                        }, 2000);
                    } catch (error) {
                        console.error('VRChat画像取得エラー:', error);
                        alert('VRChatから画像を取得できませんでした。\nURLが正しいか、アバターが公開設定か確認してください。');
                        fetchBtn.innerHTML = originalText;
                        fetchBtn.disabled = false;
                    }
                });
            }

            // VRChat URLからアバター名を取得ボタン（編集モーダル用 - イベント委譲）
            document.body.addEventListener('click', async (e) => {
                const nameBtn = e.target.closest('.fetch-name-from-vrchat-btn');
                if (!nameBtn) return;

                const modal = nameBtn.closest('#editModal');
                if (!modal) return;

                const avatarUrlInput = modal.querySelector('.edit-avatar-url-input');
                const avatarNameInput = modal.querySelector('input[name="avatarName"]');
                if (!avatarUrlInput || !avatarNameInput) return;

                const url = avatarUrlInput.value.trim();
                if (!url) {
                    alert('VRChat URLを入力してください');
                    return;
                }

                // avtr_xxx を抽出
                const match = url.match(/avtr_[A-Za-z0-9-]+/);
                if (!match) {
                    alert('有効なVRChatアバターURLを入力してください\n例: https://vrchat.com/home/avatar/avtr_xxx...');
                    return;
                }

                const avtrId = match[0];
                nameBtn.disabled = true;
                const originalText = nameBtn.innerHTML;
                nameBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>取得中...</span>';

                try {
                    const response = await fetch(`/api/vrc-avatar-info?avtr=${avtrId}`);
                    if (!response.ok) {
                        throw new Error(`アバター情報取得に失敗しました: ${response.status}`);
                    }

                    const data = await response.json();

                    // アバター名を上書き
                    avatarNameInput.value = data.avatarName || '';

                    // 成功メッセージ
                    nameBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>取得完了！</span>';
                    setTimeout(() => {
                        nameBtn.innerHTML = originalText;
                        nameBtn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('VRChatアバター名取得エラー:', error);
                    alert('VRChatからアバター名を取得できませんでした。\nURLが正しいか、アバターが公開設定か確認してください。');
                    nameBtn.innerHTML = originalText;
                    nameBtn.disabled = false;
                }
            });

            // VRChat URLから画像を取得ボタン（編集モーダル用 - イベント委譲）
            document.body.addEventListener('click', async (e) => {
                const btn = e.target.closest('.fetch-image-from-vrchat-btn');
                if (!btn) return;

                const modal = btn.closest('#editModal');
                if (!modal) return;

                const avatarUrlInput = modal.querySelector('.edit-avatar-url-input');
                if (!avatarUrlInput) return;

                const url = avatarUrlInput.value.trim();
                if (!url) {
                    alert('VRChat URLを入力してください');
                    return;
                }

                // avtr_xxx を抽出
                const match = url.match(/avtr_[A-Za-z0-9-]+/);
                if (!match) {
                    alert('有効なVRChatアバターURLを入力してください\n例: https://vrchat.com/home/avatar/avtr_xxx...');
                    return;
                }

                const avtrId = match[0];
                btn.disabled = true;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>取得中...</span>';

                try {
                    const response = await fetch(`/api/vrc-avatar-image?avtr=${avtrId}&w=1024`);
                    if (!response.ok) {
                        throw new Error(`画像取得に失敗しました: ${response.status}`);
                    }

                    const blob = await response.blob();
                    const file = new File([blob], `${avtrId}.webp`, { type: 'image/webp' });

                    // 編集モーダル用の画像処理フローに統合
                    if (typeof handleEditImageFileWithCrop === 'function') {
                        handleEditImageFileWithCrop(file);
                    }

                    // 成功メッセージ
                    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>取得完了！</span>';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('VRChat画像取得エラー:', error);
                    alert('VRChatから画像を取得できませんでした。\nURLが正しいか、アバターが公開設定か確認してください。');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });

        // 画像選択処理（トリミング付き）
        function handleImageSelectWithCrop(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageFileWithCrop(file);
            }
        }

        // 画像ファイル処理（トリミング付き）
        function handleImageFileWithCrop(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imgSrc = e.target.result;
                originalImageSrc = imgSrc;

                // プレビューを表示
                document.getElementById('imagePreview').classList.remove('hidden');
                const cropImg = document.getElementById('cropImage');
                cropImg.src = imgSrc;

                // 画像サイズを調整
                cropImg.onload = () => {
                    const container = document.getElementById('cropContainer');
                    const containerWidth = container.offsetWidth;
                    const containerHeight = container.offsetHeight;
                    const imgAspect = cropImg.naturalWidth / cropImg.naturalHeight;
                    const containerAspect = containerWidth / containerHeight;

                    // 初期スケール設定
                    if (imgAspect > containerAspect) {
                        cropImg.style.height = containerHeight + 'px';
                        cropImg.style.width = 'auto';
                    } else {
                        cropImg.style.width = containerWidth + 'px';
                        cropImg.style.height = 'auto';
                    }

                    // 中央配置
                    const imgWidth = cropImg.offsetWidth;
                    const imgHeight = cropImg.offsetHeight;
                    imageX = (containerWidth - imgWidth) / 2;
                    imageY = (containerHeight - imgHeight) / 2;

                    resetImagePosition();
                    initCropping();
                };
            };
            reader.readAsDataURL(file);
        }

        // フォーム送信時にトリミング画像を生成
        window.generateCroppedImage = function() {
            return new Promise((resolve) => {
                const container = document.getElementById('cropContainer');
                const imgEl = document.getElementById('cropImage');
                if (!container || !imgEl || !imgEl.src || imgEl.src === window.location.href) {
                    resolve(null);
                    return;
                }

                const canvasW = 300;
                const canvasH = 200;
                const canvas = document.createElement('canvas');
                canvas.width = canvasW;
                canvas.height = canvasH;
                const ctx = canvas.getContext('2d');

                const image = new Image();
                image.onload = () => {
                    const cw = container.offsetWidth;
                    const ch = container.offsetHeight;
                    const iw = image.naturalWidth;
                    const ih = image.naturalHeight;
                    const containerAspect = cw / ch;
                    const imageAspect = iw / ih;

                    const baseScale = imageAspect > containerAspect ? (ch / ih) : (cw / iw);
                    const totalScale = baseScale * imageScale;

                    const sx = Math.max(0, (-imageX) / totalScale);
                    const sy = Math.max(0, (-imageY) / totalScale);
                    const sw = Math.min(iw - sx, cw / totalScale);
                    const sh = Math.min(ih - sy, ch / totalScale);

                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvasW, canvasH);
                    ctx.drawImage(image, sx, sy, sw, sh, 0, 0, canvasW, canvasH);

                    canvas.toBlob((blob) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.9);
                };
                image.crossOrigin = 'anonymous';
                image.src = originalImageSrc || imgEl.src;
            });
        };
    </script>
<!-- ▼ 編集モーダル用スクリプト：完全版（そのままコピペ） ▼ -->
<script>
    // ====== 編集モーダル：画像D&D＋トリミング（新規側と変数名を分離） ======
    let editImageScale = 1;
    let editImageX = 0;
    let editImageY = 0;
    let editIsDragging = false;
    let editDragStartX = 0;
    let editDragStartY = 0;
    let originalEditImageSrc = null;

    function updateEditImageTransform() {
      const img = document.getElementById('editCropImage');
      if (img) {
        img.style.transform = `translate(${editImageX}px, ${editImageY}px) scale(${editImageScale})`;
      }
    }

    function resetEditImagePosition() {
      editImageScale = 1;
      const container = document.getElementById('editCropContainer');
      const img = document.getElementById('editCropImage');
      if (container && img) {
        const cw = container.offsetWidth;
        const ch = container.offsetHeight;
        const iw = img.offsetWidth;
        const ih = img.offsetHeight;
        editImageX = (cw - iw) / 2;
        editImageY = (ch - ih) / 2;
      } else {
        editImageX = 0;
        editImageY = 0;
      }
      updateEditImageTransform();
    }

    function zoomEditImage(factor) {
      editImageScale *= factor;
      editImageScale = Math.max(0.5, Math.min(3, editImageScale));
      updateEditImageTransform();
    }

    function initEditCropping() {
      const container = document.getElementById('editCropContainer');
      const img = document.getElementById('editCropImage');
      if (!container || !img) return;

      // Wheel zoom
      container.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = Math.sign(e.deltaY);
        zoomEditImage(delta < 0 ? 1.1 : 0.9);
      });

      // Mouse drag
      img.addEventListener('mousedown', (e) => {
        editIsDragging = true;
        editDragStartX = e.clientX - editImageX;
        editDragStartY = e.clientY - editImageY;
      });
      document.addEventListener('mousemove', (e) => {
        if (editIsDragging) {
          editImageX = e.clientX - editDragStartX;
          editImageY = e.clientY - editDragStartY;
          updateEditImageTransform();
        }
      });
      document.addEventListener('mouseup', () => { editIsDragging = false; });

      // Touch drag
      img.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
          editIsDragging = true;
          editDragStartX = e.touches[0].clientX - editImageX;
          editDragStartY = e.touches[0].clientY - editImageY;
        }
      });
      document.addEventListener('touchmove', (e) => {
        if (editIsDragging && e.touches.length === 1) {
          editImageX = e.touches[0].clientX - editDragStartX;
          editImageY = e.touches[0].clientY - editDragStartY;
          updateEditImageTransform();
        }
      });
      document.addEventListener('touchend', () => { editIsDragging = false; });
    }

    function handleEditImageSelectWithCrop(event) {
      const file = event.target.files && event.target.files[0];
      if (file && file.type && file.type.startsWith('image/')) {
        handleEditImageFileWithCrop(file);
      }
    }

    function handleEditImageFileWithCrop(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const imgSrc = e.target.result;
        originalEditImageSrc = imgSrc;

        const preview = document.getElementById('editImagePreview');
        if (preview) preview.classList.remove('hidden');

        const cropImg = document.getElementById('editCropImage');
        if (!cropImg) return;

        cropImg.onload = () => {
          const container = document.getElementById('editCropContainer');
          if (!container) return;

          // アスペクト比3:2で全面を覆うようにリサイズ
          const cw = container.offsetWidth;
          const ch = container.offsetHeight;
          const iw = cropImg.naturalWidth;
          const ih = cropImg.naturalHeight;
          const containerAspect = cw / ch;
          const imageAspect = iw / ih;
          let drawW, drawH;
          if (imageAspect > containerAspect) {
            drawH = ch;
            drawW = ch * imageAspect;
          } else {
            drawW = cw;
            drawH = cw / imageAspect;
          }
          cropImg.style.width = `${drawW}px`;
          cropImg.style.height = `${drawH}px`;

          resetEditImagePosition();
          initEditCropping();
        };
        cropImg.src = imgSrc;
      };
      reader.readAsDataURL(file);
    }

    // 編集用のトリミング済み画像（300x200）をBase64で返す
    window.generateEditCroppedImage = function () {
      return new Promise((resolve) => {
        const container = document.getElementById('editCropContainer');
        const imgEl = document.getElementById('editCropImage');
        if (!container || !imgEl || !imgEl.src || imgEl.src === window.location.href) {
          resolve(null);
          return;
        }

        const canvasW = 300;
        const canvasH = 200;
        const canvas = document.createElement('canvas');
        canvas.width = canvasW;
        canvas.height = canvasH;
        const ctx = canvas.getContext('2d');

        const image = new Image();
        image.onload = () => {
          const cw = container.offsetWidth;
          const ch = container.offsetHeight;
          const iw = image.naturalWidth;
          const ih = image.naturalHeight;

          // 表示上の拡大率と平行移動をもとに、ソースの描画領域を逆算
          const containerAspect = cw / ch;
          const imageAspect = iw / ih;
          let drawW, drawH;
          if (imageAspect > containerAspect) {
            drawH = ch;
            drawW = ch * imageAspect;
          } else {
            drawW = cw;
            drawH = cw / imageAspect;
          }

          // 表示ピクセル→元画像ピクセルへの変換係数
          const scaleFactorW = iw / drawW;
          const scaleFactorH = ih / drawH;

          // 現在の変換（translate+scale）を考慮
          const sx = Math.max(0, (-editImageX) * scaleFactorW / editImageScale);
          const sy = Math.max(0, (-editImageY) * scaleFactorH / editImageScale);
          const sw = Math.min(iw - sx, (cw * scaleFactorW) / editImageScale);
          const sh = Math.min(ih - sy, (ch * scaleFactorH) / editImageScale);

          // 背景を白にして描画
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvasW, canvasH);
          ctx.drawImage(image, sx, sy, sw, sh, 0, 0, canvasW, canvasH);

          canvas.toBlob((blob) => {
            const r = new FileReader();
            r.onloadend = () => resolve(r.result);
            r.readAsDataURL(blob);
          }, 'image/jpeg', 0.9);
        };
        image.crossOrigin = 'anonymous';
        image.src = originalEditImageSrc || imgEl.src;
      });
    };

    // 初期化（重複防止付き）
    (function initEditDnDOnce() {
      if (window.__editDnDInited) return;
      window.__editDnDInited = true;

      document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('editImageInput');
        if (input) input.addEventListener('change', handleEditImageSelectWithCrop);

        const dz = document.getElementById('editImageDropZone');
        if (dz) {
          ['dragenter', 'dragover'].forEach(type => dz.addEventListener(type, (e) => {
            e.preventDefault();
            dz.classList.add('dragover');
          }));
          ['dragleave', 'dragend', 'drop'].forEach(type => dz.addEventListener(type, (e) => {
            e.preventDefault();
            dz.classList.remove('dragover');
          }));
          dz.addEventListener('drop', (e) => {
            const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
            if (f && f.type && f.type.startsWith('image/')) {
              handleEditImageFileWithCrop(f);
            }
          });
        }
      });
    })();
    </script>
    <!-- ▲ 編集モーダル用スクリプト：完全版（ここまで） ▲ -->

    <!-- フォールバックスクリプトは重複と競合回避のため削除（admin.js 実装を使用） -->
</body>
</html>
