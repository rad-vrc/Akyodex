<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akyoずかん - ロゴ設定（オーナー専用）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/kid-friendly.css">
    <style>
        .crop-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
            background: #f0f0f0;
            border-radius: 10px;
        }
        
        .crop-area {
            position: absolute;
            border: 3px solid #FF6B9D;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            cursor: move;
            box-sizing: border-box;
        }
        
        .resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid #FF6B9D;
            border-radius: 50%;
            cursor: nwse-resize;
        }
        
        .resize-handle-e {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: ew-resize;
        }
        
        .resize-handle-w {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: ew-resize;
        }
        
        .resize-handle-se {
            bottom: -8px;
            right: -8px;
            cursor: nwse-resize;
        }
        
        canvas {
            border: 3px solid #66B2FF;
            border-radius: 10px;
            background: white;
        }
        
        .tab-button {
            padding: 10px 20px;
            border-radius: 10px 10px 0 0;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            background: white;
            color: #FF6B9D;
            transform: translateY(2px);
        }
        
        .tab-button:not(.active) {
            background: linear-gradient(135deg, #FFB6C1, #FFC0CB);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-black mb-2 rainbow-text">
                <i class="fas fa-image mr-2"></i>ロゴ設定
            </h1>
            <p class="text-gray-600">ヘッダーロゴとプロフィールアイコンの設定ができます</p>
        </header>

        <!-- 認証セクション -->
        <div id="authSection" class="card-style mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">🔒 オーナー認証</h2>
            <div class="flex gap-2">
                <input type="password" id="passwordInput" placeholder="オーナーパスワード" 
                       class="flex-1 px-4 py-2 border-2 border-purple-300 rounded-full focus:border-purple-500 focus:outline-none">
                <button onclick="authenticate()" 
                        class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full hover:scale-105 transition font-bold">
                    認証
                </button>
            </div>
            <p id="authError" class="text-red-500 mt-2 hidden">パスワードが違います</p>
        </div>

        <!-- メイン設定（認証後に表示） -->
        <div id="mainSection" class="hidden">
            <!-- タブナビゲーション -->
            <div class="flex gap-2 mb-6">
                <button id="headerTab" class="tab-button active" onclick="switchTab('header')">
                    <i class="fas fa-image mr-2"></i>ヘッダーロゴ
                </button>
                <button id="profileTab" class="tab-button" onclick="switchTab('profile')">
                    <i class="fas fa-user-circle mr-2"></i>プロフィールアイコン
                </button>
            </div>

            <!-- ヘッダーロゴ設定 -->
            <div id="headerSection">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">
                        <i class="fas fa-panorama mr-2 text-purple-500"></i>ヘッダーロゴ（横長画像）
                    </h2>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                        <p class="text-blue-700">
                            <i class="fas fa-info-circle mr-2"></i>
                            「Akyoずかん」のテキストとアイコンが一体になった横長透過PNGをアップロードしてください。
                            高さは48pxに固定され、幅は最大300pxまで自動調整されます。
                        </p>
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-3">
                        💡 どんな解像度の画像でも最適にトリミングできます。マウスホイールで拡大・縮小、ドラッグで位置調整、ハンドルでサイズ変更が可能です。
                    </p>
                    
                    <input type="file" id="headerLogoInput" accept="image/*" 
                           class="mb-4 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
                    
                    <div id="headerCropContainer" class="hidden mb-4">
                        <div class="crop-container" style="height: 400px;">
                            <img id="headerImage" style="max-width: 100%; max-height: 100%;">
                            <div id="headerCropArea" class="crop-area">
                                <div class="resize-handle resize-handle-e"></div>
                                <div class="resize-handle resize-handle-w"></div>
                                <div class="resize-handle resize-handle-se"></div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            <button onclick="cropImage('header')" 
                                    class="px-4 py-2 bg-green-500 text-white rounded-full hover:bg-green-600">
                                <i class="fas fa-crop mr-2"></i>切り抜き
                            </button>
                            <button onclick="resetCrop('header')" 
                                    class="px-4 py-2 bg-gray-500 text-white rounded-full hover:bg-gray-600">
                                <i class="fas fa-undo mr-2"></i>リセット
                            </button>
                        </div>
                    </div>
                    
                    <div id="headerPreview" class="hidden">
                        <p class="font-semibold mb-2">プレビュー（実際の表示サイズ）:</p>
                        <div class="bg-gradient-to-r from-purple-100 via-pink-100 to-blue-100 p-4 rounded-lg">
                            <canvas id="headerPreviewCanvas" width="300" height="48"></canvas>
                        </div>
                        <button onclick="saveLogo('header')" 
                                class="mt-4 px-6 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-full hover:scale-105 transition font-bold">
                            <i class="fas fa-save mr-2"></i>保存
                        </button>
                    </div>
                </div>
            </div>

            <!-- プロフィールアイコン設定 -->
            <div id="profileSection" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">
                        <i class="fas fa-id-card mr-2 text-purple-500"></i>プロフィールアイコン
                    </h2>
                    
                    <p class="text-gray-600 text-sm mb-3">
                        💡 詳細画面の番号横に表示される正方形のアイコンです。
                    </p>
                    
                    <input type="file" id="profileIconInput" accept="image/*" 
                           class="mb-4 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
                    
                    <div id="profileCropContainer" class="hidden mb-4">
                        <div class="crop-container" style="height: 400px;">
                            <img id="profileImage" style="max-width: 100%; max-height: 100%;">
                            <div id="profileCropArea" class="crop-area">
                                <div class="resize-handle resize-handle-se"></div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            <button onclick="cropImage('profile')" 
                                    class="px-4 py-2 bg-green-500 text-white rounded-full hover:bg-green-600">
                                <i class="fas fa-crop mr-2"></i>切り抜き
                            </button>
                            <button onclick="resetCrop('profile')" 
                                    class="px-4 py-2 bg-gray-500 text-white rounded-full hover:bg-gray-600">
                                <i class="fas fa-undo mr-2"></i>リセット
                            </button>
                        </div>
                    </div>
                    
                    <div id="profilePreview" class="hidden">
                        <p class="font-semibold mb-2">プレビュー:</p>
                        <canvas id="profilePreviewCanvas" width="100" height="100"></canvas>
                        <button onclick="saveLogo('profile')" 
                                class="mt-4 px-6 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-full hover:scale-105 transition font-bold">
                            <i class="fas fa-save mr-2"></i>保存
                        </button>
                    </div>
                </div>
            </div>

            <!-- 現在の設定 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-images mr-2 text-green-500"></i>現在の設定
                </h2>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-600 mb-2">ヘッダーロゴ</p>
                        <div id="currentHeaderLogo" class="bg-gray-100 p-4 rounded-lg min-h-[60px] flex items-center justify-center">
                            <span class="text-2xl font-bold text-gray-400">未設定</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 mb-2">プロフィールアイコン</p>
                        <div id="currentProfileIcon" class="w-20 h-20 mx-auto bg-gray-200 rounded-lg flex items-center justify-center">
                            <span class="text-3xl">🎆</span>
                        </div>
                    </div>
                </div>
                <button onclick="clearAll()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600">
                    <i class="fas fa-trash mr-2"></i>すべてクリア
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/storage-manager.js"></script>
    <script src="js/storage-adapter.js"></script>
    <script>
        let loadedImages = {};
        let cropData = {};

        // ファイル入力の設定
        document.getElementById('headerLogoInput').addEventListener('change', (e) => handleFileSelect(e, 'header'));
        document.getElementById('profileIconInput').addEventListener('change', (e) => handleFileSelect(e, 'profile'));

        // 認証
        function authenticate() {
            const password = document.getElementById('passwordInput').value;
            
            if (password === 'RadAkyo') {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                loadCurrentLogos();
            } else {
                document.getElementById('authError').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('authError').classList.add('hidden');
                }, 3000);
            }
        }

        // タブ切り替え
        function switchTab(tab) {
            if (tab === 'header') {
                document.getElementById('headerTab').classList.add('active');
                document.getElementById('profileTab').classList.remove('active');
                document.getElementById('headerSection').classList.remove('hidden');
                document.getElementById('profileSection').classList.add('hidden');
            } else {
                document.getElementById('headerTab').classList.remove('active');
                document.getElementById('profileTab').classList.add('active');
                document.getElementById('headerSection').classList.add('hidden');
                document.getElementById('profileSection').classList.remove('hidden');
            }
        }

        // 現在のロゴを読み込み
        async function loadCurrentLogos() {
            try {
                // ヘッダーロゴ
                let headerLogo = null;
                if (window.storageManager && window.storageManager.isIndexedDBAvailable) {
                    await window.storageManager.init();
                    headerLogo = await window.storageManager.getImage('headerLogo');
                }
                if (!headerLogo) {
                    headerLogo = localStorage.getItem('akyoHeaderLogo');
                }
                if (headerLogo) {
                    document.getElementById('currentHeaderLogo').innerHTML = 
                        `<img src="${headerLogo}" class="h-12 w-auto object-contain" style="max-width: 300px;">`;
                }
                
                // プロフィールアイコン
                let profileIcon = null;
                if (window.storageManager && window.storageManager.isIndexedDBAvailable) {
                    profileIcon = await window.storageManager.getImage('profileIcon');
                }
                if (!profileIcon) {
                    profileIcon = localStorage.getItem('akyoProfileIcon');
                }
                if (profileIcon) {
                    document.getElementById('currentProfileIcon').innerHTML = 
                        `<img src="${profileIcon}" class="w-full h-full object-cover rounded-lg">`;
                }
            } catch (error) {
                console.error('ロゴの読み込みに失敗:', error);
            }
        }

        // ファイル選択処理
        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    loadedImages[type] = img;
                    setupCrop(type, e.target.result);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // クロップ設定
        function setupCrop(type, imageSrc) {
            const container = document.getElementById(`${type}CropContainer`);
            const image = document.getElementById(`${type}Image`);
            const cropArea = document.getElementById(`${type}CropArea`);
            
            image.src = imageSrc;
            container.classList.remove('hidden');
            document.getElementById(`${type}Preview`).classList.add('hidden');
            
            // クロップエリアの初期設定
            setTimeout(() => {
                const rect = image.getBoundingClientRect();
                
                if (type === 'header') {
                    // ヘッダーロゴ用：横長の初期設定
                    const aspectRatio = 300 / 48; // 6.25:1
                    const height = rect.height * 0.3;
                    const width = height * aspectRatio;
                    
                    cropData[type] = {
                        x: (rect.width - width) / 2,
                        y: (rect.height - height) / 2,
                        width: Math.min(width, rect.width * 0.9),
                        height: height
                    };
                } else {
                    // プロフィールアイコン用：正方形の初期設定
                    const size = Math.min(rect.width, rect.height) * 0.8;
                    cropData[type] = {
                        x: (rect.width - size) / 2,
                        y: (rect.height - size) / 2,
                        width: size,
                        height: size
                    };
                }
                
                updateCropArea(type);
            }, 100);
            
            // ドラッグとリサイズ機能
            setupDragAndResize(type);
        }

        // クロップエリア更新
        function updateCropArea(type) {
            const cropArea = document.getElementById(`${type}CropArea`);
            const data = cropData[type];
            
            cropArea.style.left = data.x + 'px';
            cropArea.style.top = data.y + 'px';
            cropArea.style.width = data.width + 'px';
            cropArea.style.height = data.height + 'px';
        }

        // ドラッグとリサイズ設定
        function setupDragAndResize(type) {
            const cropArea = document.getElementById(`${type}CropArea`);
            const image = document.getElementById(`${type}Image`);
            const handles = cropArea.querySelectorAll('.resize-handle');
            
            let isDragging = false;
            let isResizing = false;
            let currentHandle = null;
            let startX, startY, startWidth, startHeight, startCropX, startCropY;
            
            // ドラッグ
            cropArea.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle')) {
                    isResizing = true;
                    currentHandle = e.target;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = cropData[type].width;
                    startHeight = cropData[type].height;
                    startCropX = cropData[type].x;
                    startCropY = cropData[type].y;
                } else {
                    isDragging = true;
                    startX = e.clientX - cropData[type].x;
                    startY = e.clientY - cropData[type].y;
                }
                e.preventDefault();
            });
            
            // マウスホイールでサイズ変更
            cropArea.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -10 : 10;
                const rect = image.getBoundingClientRect();
                
                if (type === 'header') {
                    // 横長：アスペクト比を維持
                    const aspectRatio = cropData[type].width / cropData[type].height;
                    cropData[type].height = Math.max(20, Math.min(rect.height, cropData[type].height + delta));
                    cropData[type].width = cropData[type].height * aspectRatio;
                    
                    // 境界チェック
                    if (cropData[type].width > rect.width) {
                        cropData[type].width = rect.width;
                        cropData[type].height = cropData[type].width / aspectRatio;
                    }
                } else {
                    // 正方形：サイズを同じに
                    const newSize = Math.max(50, Math.min(
                        Math.min(rect.width - cropData[type].x, rect.height - cropData[type].y),
                        cropData[type].width + delta
                    ));
                    cropData[type].width = newSize;
                    cropData[type].height = newSize;
                }
                
                updateCropArea(type);
            });
            
            document.addEventListener('mousemove', (e) => {
                const rect = image.getBoundingClientRect();
                
                if (isDragging) {
                    cropData[type].x = Math.max(0, Math.min(rect.width - cropData[type].width, e.clientX - startX));
                    cropData[type].y = Math.max(0, Math.min(rect.height - cropData[type].height, e.clientY - startY));
                    updateCropArea(type);
                } else if (isResizing) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    if (type === 'header') {
                        // 横長の場合
                        if (currentHandle.classList.contains('resize-handle-e')) {
                            cropData[type].width = Math.max(100, Math.min(rect.width - startCropX, startWidth + deltaX));
                            cropData[type].height = cropData[type].width / (300 / 48);
                        } else if (currentHandle.classList.contains('resize-handle-w')) {
                            const newWidth = Math.max(100, Math.min(startCropX + startWidth, startWidth - deltaX));
                            cropData[type].x = startCropX + (startWidth - newWidth);
                            cropData[type].width = newWidth;
                            cropData[type].height = newWidth / (300 / 48);
                        } else if (currentHandle.classList.contains('resize-handle-se')) {
                            const aspectRatio = 300 / 48;
                            const newWidth = Math.max(100, Math.min(rect.width - startCropX, startWidth + deltaX));
                            cropData[type].width = newWidth;
                            cropData[type].height = newWidth / aspectRatio;
                        }
                    } else {
                        // 正方形の場合
                        const newSize = Math.max(50, Math.min(
                            Math.min(rect.width - startCropX, rect.height - startCropY),
                            startWidth + Math.max(deltaX, deltaY)
                        ));
                        cropData[type].width = newSize;
                        cropData[type].height = newSize;
                    }
                    
                    updateCropArea(type);
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                isResizing = false;
                currentHandle = null;
            });
        }

        // 画像を切り抜き
        function cropImage(type) {
            const img = loadedImages[type];
            const data = cropData[type];
            const image = document.getElementById(`${type}Image`);
            
            if (!img) return;
            
            // 画像の実際のサイズと表示サイズの比率を計算
            const rect = image.getBoundingClientRect();
            const scaleX = img.width / rect.width;
            const scaleY = img.height / rect.height;
            
            // キャンバスの設定
            let canvas, ctx;
            if (type === 'header') {
                canvas = document.getElementById('headerPreviewCanvas');
                ctx = canvas.getContext('2d');
                canvas.width = 300;
                canvas.height = 48;
            } else {
                canvas = document.getElementById('profilePreviewCanvas');
                ctx = canvas.getContext('2d');
                canvas.width = 100;
                canvas.height = 100;
            }
            
            // クリアして描画
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(
                img, 
                data.x * scaleX, 
                data.y * scaleY, 
                data.width * scaleX, 
                data.height * scaleY, 
                0, 0, 
                canvas.width, 
                canvas.height
            );
            
            document.getElementById(`${type}Preview`).classList.remove('hidden');
        }

        // リセット
        function resetCrop(type) {
            document.getElementById(`${type}CropContainer`).classList.add('hidden');
            document.getElementById(`${type}Preview`).classList.add('hidden');
            if (type === 'header') {
                document.getElementById('headerLogoInput').value = '';
            } else {
                document.getElementById('profileIconInput').value = '';
            }
        }

        // ロゴを保存
        async function saveLogo(type) {
            let canvas;
            if (type === 'header') {
                canvas = document.getElementById('headerPreviewCanvas');
            } else {
                canvas = document.getElementById('profilePreviewCanvas');
            }
            
            const dataUrl = canvas.toDataURL('image/png');
            
            // IndexedDBに保存を試行
            if (window.storageManager && window.storageManager.isIndexedDBAvailable) {
                try {
                    await window.storageManager.init();
                    const key = type === 'header' ? 'headerLogo' : 'profileIcon';
                    await window.storageManager.saveImage(key, dataUrl);
                    console.log(`${type}をIndexedDBに保存しました`);
                } catch (error) {
                    console.error('IndexedDBへの保存に失敗:', error);
                }
            }
            
            // localStorageにも保存
            try {
                const key = type === 'header' ? 'akyoHeaderLogo' : 'akyoProfileIcon';
                localStorage.setItem(key, dataUrl);
                console.log(`${type}をlocalStorageに保存しました`);
            } catch (error) {
                console.error('localStorageへの保存に失敗:', error);
            }
            
            const typeName = type === 'header' ? 'ヘッダーロゴ' : 'プロフィールアイコン';
            alert(`${typeName}を保存しました！`);
            loadCurrentLogos();
            
            // メインページに反映
            if (confirm('変更を反映するために、メインページをリロードしますか？')) {
                window.open('index.html', '_blank');
            }
        }

        // すべてクリア
        async function clearAll() {
            if (confirm('すべてのロゴをクリアしますか？')) {
                // IndexedDBから削除
                if (window.storageManager && window.storageManager.isIndexedDBAvailable) {
                    try {
                        await window.storageManager.init();
                        await window.storageManager.deleteImage('headerLogo');
                        await window.storageManager.deleteImage('profileIcon');
                    } catch (error) {
                        console.error('IndexedDBからの削除に失敗:', error);
                    }
                }
                
                // localStorageから削除
                localStorage.removeItem('akyoHeaderLogo');
                localStorage.removeItem('akyoProfileIcon');
                
                alert('すべてのロゴをクリアしました');
                loadCurrentLogos();
                location.reload();
            }
        }

        // ページ読み込み時に現在のロゴを読み込み
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentLogos();
        });
    </script>
</body>
</html>