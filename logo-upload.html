<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akyoãšã‹ã‚“ - ãƒ­ã‚´è¨­å®šï¼ˆã‚ªãƒ¼ãƒŠãƒ¼å°‚ç”¨ï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/kid-friendly.css">
    <style>
        .crop-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
            background: #f0f0f0;
            border-radius: 10px;
        }
        
        .crop-area {
            position: absolute;
            border: 3px solid #FF6B9D;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            cursor: move;
            box-sizing: border-box;
        }
        
        .resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid #FF6B9D;
            border-radius: 50%;
            cursor: nwse-resize;
        }
        
        .resize-handle-e {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: ew-resize;
        }
        
        .resize-handle-w {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: ew-resize;
        }
        
        .resize-handle-se {
            bottom: -8px;
            right: -8px;
            cursor: nwse-resize;
        }
        
        canvas {
            border: 3px solid #66B2FF;
            border-radius: 10px;
            background: white;
        }
        
        .tab-button {
            padding: 10px 20px;
            border-radius: 10px 10px 0 0;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            background: white;
            color: #FF6B9D;
            transform: translateY(2px);
        }
        
        .tab-button:not(.active) {
            background: linear-gradient(135deg, #FFB6C1, #FFC0CB);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-black mb-2 rainbow-text">
                <i class="fas fa-image mr-2"></i>ãƒ­ã‚´è¨­å®š
            </h1>
            <p class="text-gray-600">ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã®è¨­å®šãŒã§ãã¾ã™</p>
        </header>

        <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="authSection" class="card-style mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">ğŸ”’ ã‚ªãƒ¼ãƒŠãƒ¼èªè¨¼</h2>
            <div class="flex gap-2">
                <input type="password" id="passwordInput" placeholder="ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" 
                       class="flex-1 px-4 py-2 border-2 border-purple-300 rounded-full focus:border-purple-500 focus:outline-none">
                <button onclick="authenticate()" 
                        class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full hover:scale-105 transition font-bold">
                    èªè¨¼
                </button>
            </div>
            <p id="authError" class="text-red-500 mt-2 hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³è¨­å®šï¼ˆèªè¨¼å¾Œã«è¡¨ç¤ºï¼‰ -->
        <div id="mainSection" class="hidden">
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="flex gap-2 mb-6">
                <button id="headerTab" class="tab-button active" onclick="switchTab('header')">
                    <i class="fas fa-image mr-2"></i>ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´
                </button>
                <button id="profileTab" class="tab-button" onclick="switchTab('profile')">
                    <i class="fas fa-user-circle mr-2"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³
                </button>
            </div>

            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´è¨­å®š -->
            <div id="headerSection">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">
                        <i class="fas fa-panorama mr-2 text-purple-500"></i>ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´ï¼ˆæ¨ªé•·ç”»åƒï¼‰
                    </h2>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                        <p class="text-blue-700">
                            <i class="fas fa-info-circle mr-2"></i>
                            ã€ŒAkyoãšã‹ã‚“ã€ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¢ã‚¤ã‚³ãƒ³ãŒä¸€ä½“ã«ãªã£ãŸæ¨ªé•·é€éPNGã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                            é«˜ã•ã¯48pxã«å›ºå®šã•ã‚Œã€å¹…ã¯æœ€å¤§300pxã¾ã§è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™ã€‚
                        </p>
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-3">
                        ğŸ’¡ ã©ã‚“ãªè§£åƒåº¦ã®ç”»åƒã§ã‚‚æœ€é©ã«ãƒˆãƒªãƒŸãƒ³ã‚°ã§ãã¾ã™ã€‚ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§æ‹¡å¤§ãƒ»ç¸®å°ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ä½ç½®èª¿æ•´ã€ãƒãƒ³ãƒ‰ãƒ«ã§ã‚µã‚¤ã‚ºå¤‰æ›´ãŒå¯èƒ½ã§ã™ã€‚
                    </p>
                    
                    <input type="file" id="headerLogoInput" accept="image/*" 
                           class="mb-4 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
                    
                    <div id="headerCropContainer" class="hidden mb-4">
                        <div class="crop-container" style="height: 400px;">
                            <img id="headerImage" style="max-width: 100%; max-height: 100%;">
                            <div id="headerCropArea" class="crop-area">
                                <div class="resize-handle resize-handle-e"></div>
                                <div class="resize-handle resize-handle-w"></div>
                                <div class="resize-handle resize-handle-se"></div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            <button onclick="cropImage('header')" 
                                    class="px-4 py-2 bg-green-500 text-white rounded-full hover:bg-green-600">
                                <i class="fas fa-crop mr-2"></i>åˆ‡ã‚ŠæŠœã
                            </button>
                            <button onclick="resetCrop('header')" 
                                    class="px-4 py-2 bg-gray-500 text-white rounded-full hover:bg-gray-600">
                                <i class="fas fa-undo mr-2"></i>ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                    </div>
                    
                    <div id="headerPreview" class="hidden">
                        <p class="font-semibold mb-2">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå®Ÿéš›ã®è¡¨ç¤ºã‚µã‚¤ã‚ºï¼‰:</p>
                        <div class="bg-gradient-to-r from-purple-100 via-pink-100 to-blue-100 p-4 rounded-lg">
                            <canvas id="headerPreviewCanvas" width="300" height="48"></canvas>
                        </div>
                        <button onclick="saveLogo('header')" 
                                class="mt-4 px-6 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-full hover:scale-105 transition font-bold">
                            <i class="fas fa-save mr-2"></i>ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
            <div id="profileSection" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">
                        <i class="fas fa-id-card mr-2 text-purple-500"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³
                    </h2>
                    
                    <p class="text-gray-600 text-sm mb-3">
                        ğŸ’¡ è©³ç´°ç”»é¢ã®ç•ªå·æ¨ªã«è¡¨ç¤ºã•ã‚Œã‚‹æ­£æ–¹å½¢ã®ã‚¢ã‚¤ã‚³ãƒ³ã§ã™ã€‚
                    </p>
                    
                    <input type="file" id="profileIconInput" accept="image/*" 
                           class="mb-4 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
                    
                    <div id="profileCropContainer" class="hidden mb-4">
                        <div class="crop-container" style="height: 400px;">
                            <img id="profileImage" style="max-width: 100%; max-height: 100%;">
                            <div id="profileCropArea" class="crop-area">
                                <div class="resize-handle resize-handle-se"></div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            <button onclick="cropImage('profile')" 
                                    class="px-4 py-2 bg-green-500 text-white rounded-full hover:bg-green-600">
                                <i class="fas fa-crop mr-2"></i>åˆ‡ã‚ŠæŠœã
                            </button>
                            <button onclick="resetCrop('profile')" 
                                    class="px-4 py-2 bg-gray-500 text-white rounded-full hover:bg-gray-600">
                                <i class="fas fa-undo mr-2"></i>ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                    </div>
                    
                    <div id="profilePreview" class="hidden">
                        <p class="font-semibold mb-2">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</p>
                        <canvas id="profilePreviewCanvas" width="100" height="100"></canvas>
                        <button onclick="saveLogo('profile')" 
                                class="mt-4 px-6 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-full hover:scale-105 transition font-bold">
                            <i class="fas fa-save mr-2"></i>ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç¾åœ¨ã®è¨­å®š -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-images mr-2 text-green-500"></i>ç¾åœ¨ã®è¨­å®š
                </h2>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-600 mb-2">ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´</p>
                        <div id="currentHeaderLogo" class="bg-gray-100 p-4 rounded-lg min-h-[60px] flex items-center justify-center">
                            <span class="text-2xl font-bold text-gray-400">æœªè¨­å®š</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 mb-2">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³</p>
                        <div id="currentProfileIcon" class="w-20 h-20 mx-auto bg-gray-200 rounded-lg flex items-center justify-center">
                            <span class="text-3xl">ğŸ†</span>
                        </div>
                    </div>
                </div>
                <button onclick="clearAll()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600">
                    <i class="fas fa-trash mr-2"></i>ã™ã¹ã¦ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/storage-manager.js"></script>
    <script src="js/storage-adapter.js"></script>
    <script>
        let loadedImages = {};
        let cropData = {};

        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®è¨­å®š
        document.getElementById('headerLogoInput').addEventListener('change', (e) => handleFileSelect(e, 'header'));
        document.getElementById('profileIconInput').addEventListener('change', (e) => handleFileSelect(e, 'profile'));

        // èªè¨¼
        function authenticate() {
            const password = document.getElementById('passwordInput').value;
            
            if (password === 'RadAkyo') {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                loadCurrentLogos();
            } else {
                document.getElementById('authError').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('authError').classList.add('hidden');
                }, 3000);
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            if (tab === 'header') {
                document.getElementById('headerTab').classList.add('active');
                document.getElementById('profileTab').classList.remove('active');
                document.getElementById('headerSection').classList.remove('hidden');
                document.getElementById('profileSection').classList.add('hidden');
            } else {
                document.getElementById('headerTab').classList.remove('active');
                document.getElementById('profileTab').classList.add('active');
                document.getElementById('headerSection').classList.add('hidden');
                document.getElementById('profileSection').classList.remove('hidden');
            }
        }

        // ç¾åœ¨ã®ãƒ­ã‚´ã‚’èª­ã¿è¾¼ã¿
        async function loadCurrentLogos() {
            try {
                // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´
                let headerLogo = null;
                if (window.storageManager && window.storageManager.isIndexedDBAvailable) {
                    await window.storageManager.init();
                    headerLogo = await window.storageManager.getImage('headerLogo');
                }
                if (!headerLogo) {
                    headerLogo = localStorage.getItem('akyoHeaderLogo');
                }
                if (headerLogo) {
                    document.getElementById('currentHeaderLogo').innerHTML = 
                        `<img src="${headerLogo}" class="h-12 w-auto object-contain" style="max-width: 300px;">`;
                }
                
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³
                let profileIcon = null;
                if (window.storageManager && window.storageManager.isIndexedDBAvailable) {
                    profileIcon = await window.storageManager.getImage('profileIcon');
                }
                if (!profileIcon) {
                    profileIcon = localStorage.getItem('akyoProfileIcon');
                }
                if (profileIcon) {
                    document.getElementById('currentProfileIcon').innerHTML = 
                        `<img src="${profileIcon}" class="w-full h-full object-cover rounded-lg">`;
                }
            } catch (error) {
                console.error('ãƒ­ã‚´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    loadedImages[type] = img;
                    setupCrop(type, e.target.result);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ã‚¯ãƒ­ãƒƒãƒ—è¨­å®š
        function setupCrop(type, imageSrc) {
            const container = document.getElementById(`${type}CropContainer`);
            const image = document.getElementById(`${type}Image`);
            const cropArea = document.getElementById(`${type}CropArea`);
            
            image.src = imageSrc;
            container.classList.remove('hidden');
            document.getElementById(`${type}Preview`).classList.add('hidden');
            
            // ã‚¯ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®åˆæœŸè¨­å®š
            setTimeout(() => {
                const rect = image.getBoundingClientRect();
                
                if (type === 'header') {
                    // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´ç”¨ï¼šæ¨ªé•·ã®åˆæœŸè¨­å®š
                    const aspectRatio = 300 / 48; // 6.25:1
                    const height = rect.height * 0.3;
                    const width = height * aspectRatio;
                    
                    cropData[type] = {
                        x: (rect.width - width) / 2,
                        y: (rect.height - height) / 2,
                        width: Math.min(width, rect.width * 0.9),
                        height: height
                    };
                } else {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ç”¨ï¼šæ­£æ–¹å½¢ã®åˆæœŸè¨­å®š
                    const size = Math.min(rect.width, rect.height) * 0.8;
                    cropData[type] = {
                        x: (rect.width - size) / 2,
                        y: (rect.height - size) / 2,
                        width: size,
                        height: size
                    };
                }
                
                updateCropArea(type);
            }, 100);
            
            // ãƒ‰ãƒ©ãƒƒã‚°ã¨ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½
            setupDragAndResize(type);
        }

        // ã‚¯ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢æ›´æ–°
        function updateCropArea(type) {
            const cropArea = document.getElementById(`${type}CropArea`);
            const data = cropData[type];
            
            cropArea.style.left = data.x + 'px';
            cropArea.style.top = data.y + 'px';
            cropArea.style.width = data.width + 'px';
            cropArea.style.height = data.height + 'px';
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ã¨ãƒªã‚µã‚¤ã‚ºè¨­å®š
        function setupDragAndResize(type) {
            const cropArea = document.getElementById(`${type}CropArea`);
            const image = document.getElementById(`${type}Image`);
            const handles = cropArea.querySelectorAll('.resize-handle');
            
            let isDragging = false;
            let isResizing = false;
            let currentHandle = null;
            let startX, startY, startWidth, startHeight, startCropX, startCropY;
            
            // ãƒ‰ãƒ©ãƒƒã‚°
            cropArea.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle')) {
                    isResizing = true;
                    currentHandle = e.target;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = cropData[type].width;
                    startHeight = cropData[type].height;
                    startCropX = cropData[type].x;
                    startCropY = cropData[type].y;
                } else {
                    isDragging = true;
                    startX = e.clientX - cropData[type].x;
                    startY = e.clientY - cropData[type].y;
                }
                e.preventDefault();
            });
            
            // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚µã‚¤ã‚ºå¤‰æ›´
            cropArea.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -10 : 10;
                const rect = image.getBoundingClientRect();
                
                if (type === 'header') {
                    // æ¨ªé•·ï¼šã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒ
                    const aspectRatio = cropData[type].width / cropData[type].height;
                    cropData[type].height = Math.max(20, Math.min(rect.height, cropData[type].height + delta));
                    cropData[type].width = cropData[type].height * aspectRatio;
                    
                    // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
                    if (cropData[type].width > rect.width) {
                        cropData[type].width = rect.width;
                        cropData[type].height = cropData[type].width / aspectRatio;
                    }
                } else {
                    // æ­£æ–¹å½¢ï¼šã‚µã‚¤ã‚ºã‚’åŒã˜ã«
                    const newSize = Math.max(50, Math.min(
                        Math.min(rect.width - cropData[type].x, rect.height - cropData[type].y),
                        cropData[type].width + delta
                    ));
                    cropData[type].width = newSize;
                    cropData[type].height = newSize;
                }
                
                updateCropArea(type);
            });
            
            document.addEventListener('mousemove', (e) => {
                const rect = image.getBoundingClientRect();
                
                if (isDragging) {
                    cropData[type].x = Math.max(0, Math.min(rect.width - cropData[type].width, e.clientX - startX));
                    cropData[type].y = Math.max(0, Math.min(rect.height - cropData[type].height, e.clientY - startY));
                    updateCropArea(type);
                } else if (isResizing) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    if (type === 'header') {
                        // æ¨ªé•·ã®å ´åˆ
                        if (currentHandle.classList.contains('resize-handle-e')) {
                            cropData[type].width = Math.max(100, Math.min(rect.width - startCropX, startWidth + deltaX));
                            cropData[type].height = cropData[type].width / (300 / 48);
                        } else if (currentHandle.classList.contains('resize-handle-w')) {
                            const newWidth = Math.max(100, Math.min(startCropX + startWidth, startWidth - deltaX));
                            cropData[type].x = startCropX + (startWidth - newWidth);
                            cropData[type].width = newWidth;
                            cropData[type].height = newWidth / (300 / 48);
                        } else if (currentHandle.classList.contains('resize-handle-se')) {
                            const aspectRatio = 300 / 48;
                            const newWidth = Math.max(100, Math.min(rect.width - startCropX, startWidth + deltaX));
                            cropData[type].width = newWidth;
                            cropData[type].height = newWidth / aspectRatio;
                        }
                    } else {
                        // æ­£æ–¹å½¢ã®å ´åˆ
                        const newSize = Math.max(50, Math.min(
                            Math.min(rect.width - startCropX, rect.height - startCropY),
                            startWidth + Math.max(deltaX, deltaY)
                        ));
                        cropData[type].width = newSize;
                        cropData[type].height = newSize;
                    }
                    
                    updateCropArea(type);
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                isResizing = false;
                currentHandle = null;
            });
        }

        // ç”»åƒã‚’åˆ‡ã‚ŠæŠœã
        function cropImage(type) {
            const img = loadedImages[type];
            const data = cropData[type];
            const image = document.getElementById(`${type}Image`);
            
            if (!img) return;
            
            // ç”»åƒã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã¨è¡¨ç¤ºã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è¨ˆç®—
            const rect = image.getBoundingClientRect();
            const scaleX = img.width / rect.width;
            const scaleY = img.height / rect.height;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¨­å®š
            let canvas, ctx;
            if (type === 'header') {
                canvas = document.getElementById('headerPreviewCanvas');
                ctx = canvas.getContext('2d');
                canvas.width = 300;
                canvas.height = 48;
            } else {
                canvas = document.getElementById('profilePreviewCanvas');
                ctx = canvas.getContext('2d');
                canvas.width = 100;
                canvas.height = 100;
            }
            
            // ã‚¯ãƒªã‚¢ã—ã¦æç”»
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(
                img, 
                data.x * scaleX, 
                data.y * scaleY, 
                data.width * scaleX, 
                data.height * scaleY, 
                0, 0, 
                canvas.width, 
                canvas.height
            );
            
            document.getElementById(`${type}Preview`).classList.remove('hidden');
        }

        // ãƒªã‚»ãƒƒãƒˆ
        function resetCrop(type) {
            document.getElementById(`${type}CropContainer`).classList.add('hidden');
            document.getElementById(`${type}Preview`).classList.add('hidden');
            if (type === 'header') {
                document.getElementById('headerLogoInput').value = '';
            } else {
                document.getElementById('profileIconInput').value = '';
            }
        }

        // ãƒ­ã‚´ã‚’ä¿å­˜
        async function saveLogo(type) {
            let canvas;
            if (type === 'header') {
                canvas = document.getElementById('headerPreviewCanvas');
            } else {
                canvas = document.getElementById('profilePreviewCanvas');
            }
            
            const dataUrl = canvas.toDataURL('image/png');
            
            // IndexedDBã«ä¿å­˜ã‚’è©¦è¡Œ
            if (window.storageManager && window.storageManager.isIndexedDBAvailable) {
                try {
                    await window.storageManager.init();
                    const key = type === 'header' ? 'headerLogo' : 'profileIcon';
                    await window.storageManager.saveImage(key, dataUrl);
                    console.log(`${type}ã‚’IndexedDBã«ä¿å­˜ã—ã¾ã—ãŸ`);
                } catch (error) {
                    console.error('IndexedDBã¸ã®ä¿å­˜ã«å¤±æ•—:', error);
                }
            }
            
            // localStorageã«ã‚‚ä¿å­˜
            try {
                const key = type === 'header' ? 'akyoHeaderLogo' : 'akyoProfileIcon';
                localStorage.setItem(key, dataUrl);
                console.log(`${type}ã‚’localStorageã«ä¿å­˜ã—ã¾ã—ãŸ`);
            } catch (error) {
                console.error('localStorageã¸ã®ä¿å­˜ã«å¤±æ•—:', error);
            }
            
            const typeName = type === 'header' ? 'ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´' : 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³';
            alert(`${typeName}ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
            loadCurrentLogos();
            
            // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«åæ˜ 
            if (confirm('å¤‰æ›´ã‚’åæ˜ ã™ã‚‹ãŸã‚ã«ã€ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) {
                window.open('index.html', '_blank');
            }
        }

        // ã™ã¹ã¦ã‚¯ãƒªã‚¢
        async function clearAll() {
            if (confirm('ã™ã¹ã¦ã®ãƒ­ã‚´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                // IndexedDBã‹ã‚‰å‰Šé™¤
                if (window.storageManager && window.storageManager.isIndexedDBAvailable) {
                    try {
                        await window.storageManager.init();
                        await window.storageManager.deleteImage('headerLogo');
                        await window.storageManager.deleteImage('profileIcon');
                    } catch (error) {
                        console.error('IndexedDBã‹ã‚‰ã®å‰Šé™¤ã«å¤±æ•—:', error);
                    }
                }
                
                // localStorageã‹ã‚‰å‰Šé™¤
                localStorage.removeItem('akyoHeaderLogo');
                localStorage.removeItem('akyoProfileIcon');
                
                alert('ã™ã¹ã¦ã®ãƒ­ã‚´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                loadCurrentLogos();
                location.reload();
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç¾åœ¨ã®ãƒ­ã‚´ã‚’èª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentLogos();
        });
    </script>
</body>
</html>